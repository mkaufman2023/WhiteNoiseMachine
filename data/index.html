<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>White Noise Machine</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="White Noise">
    <link rel="apple-touch-icon" href="/icon.svg">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
   
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #111827;
            color: #e5e7eb;
            margin: 0;
            padding: 1.5rem;
            text-align: center;
            padding-top: env(safe-area-inset-top, 20px);
            padding-bottom: 3rem;
        }
        h1 {
            margin-bottom: 0.5rem;
        }
        h2 {
            font-size: 1.1rem;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            color: #9ca3af;
            border-top: 1px solid #374151;
            padding-top: 1.5rem;
        }
        .subtitle {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-bottom: 1.5rem;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem;
            max-width: 480px;
            margin: 0 auto;
        }
        /* Specific style for control buttons to distinguish them slightly */
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            max-width: 480px;
            margin: 0 auto;
        }
        button {
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            border: none;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            background: #1f2937;
            color: #e5e7eb;
            box-shadow: 0 8px 16px rgba(0,0,0,0.35);
            transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.15s ease;
            -webkit-tap-highlight-color: transparent;
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 22px rgba(0,0,0,0.5);
            background: #374151;
        }
        button:active {
            transform: translateY(1px) scale(0.98);
            box-shadow: 0 6px 10px rgba(0,0,0,0.4);
            background: #111827;
        }
        /* Style specifically for the darker control buttons */
        .btn-control {
            background: #252f3f;
            font-size: 0.9rem;
        }
        .status {
            margin-top: 1.5rem;
            font-size: 0.85rem;
            color: #9ca3af;
            min-height: 1.2em;
            font-family: monospace;
        }
        .warning-banner {
            background-color: #ef4444;
            color: white;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            display: none;  /* Hidden by default */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        /* NEW: Terminal / Serial Monitor Styles */
        .terminal-container {
            max-width: 480px;
            margin: 0 auto;
            text-align: left;
        }
        .terminal-window {
            background-color: #000;
            color: #00ff00; /* Classic Terminal Green */
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.8rem;
            padding: 12px;
            height: 200px;
            overflow-y: auto;
            border-radius: 0.5rem;
            border: 1px solid #374151;
            white-space: pre-wrap; /* Preserves line breaks from backend */
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 0.5rem;
        }
        .terminal-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .terminal-status {
            font-size: 0.75rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div id="hw-alert" class="warning-banner">
        ‚ö† Hardware Failure: DFPlayer not detected. Check internal wiring/SD card.
    </div>

    <h1>White Noise Machine</h1>
    <div class="subtitle">Select a sound</div>

    <div class="grid">
        <button onclick="play_track(1)">‚úà Airplane Cabin</button>
        <button onclick="play_track(2)">üåå Celestial</button>
        <button onclick="play_track(3)">‚õà Thunderstorm</button>
        <button onclick="play_track(4)">üåß Rain</button>
        <button onclick="play_track(5)">üåø Rainforest</button>
        <button onclick="play_track(6)">üèû Waterfall</button>
        <button onclick="play_track(7)">‚õ≤ Water Fountain</button>
        <button onclick="play_track(8)">üåä Ocean Waves</button>
        <button onclick="play_track(9)">üåÄ Fan</button>
        <button onclick="play_track(10)">üî• Campfire</button>
        <button onclick="play_track(11)">üöø Shower</button>
        <button onclick="play_track(12)">üí® Hairdryer</button>
        <button onclick="play_track(13)">üßπ Vacuum Cleaner</button>
    </div>

    <h2>Playback Controls</h2>
    <div class="control-grid">
        <button class="btn-control" onclick="control('previous')">‚èÆ Prev</button>
        <button class="btn-control" onclick="control('pause')">‚è∏ Pause</button>
        <button class="btn-control" onclick="control('resume')">‚ñ∂ Resume</button>
        <button class="btn-control" onclick="control('next')">‚è≠ Next</button>
        
        <button class="btn-control" onclick="control('volume_down')">üîâ Vol -</button>
        <button class="btn-control" onclick="control('stop')">‚èπ Stop</button>
        <button class="btn-control" onclick="control('volume_up')">üîä Vol +</button>

        <button class="btn-control" onclick="control('start_repeat')">üîÅ Loop On</button>
        <button class="btn-control" onclick="control('stop_repeat')">‚û° Loop Off</button>
        <button class="btn-control" onclick="control('set_eq_normal')">Set EQ Normal</button>
        <button class="btn-control" onclick="control('set_eq_rock')">Set EQ Rock</button>
        <button class="btn-control" onclick="control('set_eq_pop')">Set EQ Pop</button>
    </div>

    <h2>Web Serial Monitor</h2>
    <div class="terminal-container">
        <div id="terminal" class="terminal-window">Waiting for logs...</div>
        <div class="terminal-controls">
            <span class="terminal-status">Polling /log every 2s</span>
            <button class="btn-control" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="clearTerminal()">Clear</button>
        </div>
    </div>

    <div class="status" id="status">Ready</div>

    <script>
        const terminal = document.getElementById('terminal');
        const status_element = document.getElementById('status');

        // Logic for playing specific tracks
        async function play_track(n) {
            status_element.textContent = 'Switching to track ' + n + '...';
            try {
                const result = await fetch('/play?track=' + encodeURIComponent(n));
                if (!result.ok) {
                    status_element.textContent = 'Error: ' + result.status;
                    return;
                }
                const text = await result.text();
                status_element.textContent = text || ('Now playing track ' + n);
            } catch (e) {
                status_element.textContent = 'Request failed.';
            }
        };

        // Logic for generic control buttons
        async function control(command) {
            status_element.textContent = 'Sending: ' + command + '...';
            try {
                // Hits endpoints like /next, /stop, /vol_up
                const result = await fetch('/' + command);
                if (!result.ok) {
                    status_element.textContent = 'Error: ' + result.status;
                    return;
                }
                status_element.textContent = 'Command executed: ' + command;
            } catch (e) {
                status_element.textContent = 'Command failed: ' + command;
            }
        }

        // Serial Monitor Logic
        function clearTerminal() {
            terminal.textContent = '';
        }
        async function fetchLogs() {
            try {
                // Requires backend to have a route '/log' that returns text
                const response = await fetch('/log'); 
                if (response.ok) {
                    const text = await response.text();
                    if (text && text.length > 0) {
                        terminal.textContent += text;
                        // Auto-scroll to bottom
                        terminal.scrollTop = terminal.scrollHeight;
                    }
                }
            } catch (e) {
                // Fail silently to avoid spamming console
            }
        }

        window.onload = async function() {
            try {
                const result = await fetch('/status');
                const state = await result.text();

                if (state === "0") {
                    document.getElementById('hw-alert').style.display = 'block';
                }
            } catch (e) {
                console.log("Could not fetch status");
            }

            // Start the log polling loop (every 2000ms)
            setInterval(fetchLogs, 2000);
        };
    </script>
</body>
</html>